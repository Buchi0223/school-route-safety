# 通学路安全確認デモアプリ モバイル版UI改良 仕様書

**文書バージョン**: 1.1
**作成日**: 2026年1月16日
**最終更新日**: 2026年1月17日
**ステータス**: 実装中

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026/01/16 | 初版作成 |
| 1.1 | 2026/01/17 | Phase 1-2実装完了に伴う仕様更新、経路ノード操作仕様の変更 |

---

## 1. 概要

### 1.1 目的
モバイル版アプリのUIを改良し、より直感的で子供と保護者が一緒に楽しめる「通学路探検モード」を実装する。

### 1.2 対象ユーザー
- 小学生とその保護者
- スマートフォンでの利用を想定

### 1.3 主な変更点
- 画面下部にタブ式メニューを配置（実装済み）
- 経路検索オーバーレイの実装（実装済み）
- 新機能「通学路探検モード」の追加（未実装）
- キャラクターによるガイド機能（未実装）
- 完了時の賞状風演出（未実装）

---

## 2. 画面構成

### 2.1 基本レイアウト（実装済み）

```
┌─────────────────────────────────┐
│                                 │
│                                 │
│         地図表示エリア           │
│         （フルスクリーン）        │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  ボトムナビゲーション（タブ式）    │
└─────────────────────────────────┘
```

### 2.2 ボトムナビゲーション（実装済み）

| メニュー項目 | アイコン | 説明 |
|-------------|---------|------|
| 経路検索 | Route | 出発地〜目的地の経路設定 |
| 通学路探検 | Backpack | 探検モードの開始（未実装） |
| ヘルプ | HelpCircle | 危険タイプ説明・操作ガイド（未実装） |

**デザイン仕様（実装済み）**:
- 高さ: 64px
- 背景色: #FFFFFF（白）
- 上部ボーダー: 1px solid #E5E5E5
- メニューアイテム: 均等配置、タップ領域は高さ全体
- アクティブ状態: 青色ハイライト

---

## 3. 経路検索機能（実装済み）

### 3.1 概要
既存の経路検索機能をオーバーレイ形式で表示する。

### 3.2 オーバーレイUI（実装済み）

```
┌─────────────────────────────────┐
│                                 │
│         地図表示エリア           │
│                                 │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ 経路検索              ✕    │ │
│ ├─────────────────────────────┤ │
│ │ [S] スタート  [G] ゴール   │ │ ← 横並びレイアウト
│ ├─────────────────────────────┤ │
│ │ 操作ヒント（1行表示）       │ │
│ ├─────────────────────────────┤ │
│ │ [クリア] [ルート計算]      │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│  ボトムナビゲーション            │
└─────────────────────────────────┘
```

### 3.3 動作フロー（実装済み）
1. ボトムナビから「経路検索」をタップ
2. オーバーレイが画面下部から表示
3. **オーバーレイ表示中も地図操作が可能**（背景タップで閉じない）
4. 地図をタップしてスタート/ゴールを設定
5. 「ルート計算」で経路を表示
6. ✕ボタンでオーバーレイを閉じる

### 3.4 経路ノード操作仕様（実装済み・変更あり）

**PC版・モバイル版共通**:
- マーカーをクリック/タップ → ポップアップ表示
- ポップアップ内の「移動」ボタン → 移動モードに切り替え
  - 地図をクリック/タップして新しい位置に移動
  - 「キャンセル」ボタンまたはESCキーで解除
- ポップアップ内の「削除」ボタン → ノードを削除

**変更理由**:
- 当初はPC版で「長押しで削除、ドラッグで移動」を採用していたが、操作が競合するため統一
- モバイル版の長押し削除も不安定だったため、ボタン操作に変更

**操作説明テキスト（RouteControls.tsx）**:
```
• クリック: 地点を追加（最初=出発、途中=経由）
• ダブルクリック: 目的地を設定して終了
• マーカーをクリック → 移動/削除ボタンで操作
```

---

## 4. 通学路探検モード（未実装）

### 4.1 概要
保護者と子供が一緒に通学路の危険について考える体験型学習モード。

### 4.2 キャラクター仕様

**キャラクター名**: 未定（仮称: セーフティにゃん）

**画像ファイル**: `public/images/character.png`（配置済み）
- ヘルメットを被った白猫
- Hondaのバンダナ着用
- 表情: 笑顔

**表示仕様**:
- サイズ: 80px × 80px（モバイル）
- 位置: 画面左下
- 背景: なし（透過PNG使用）

### 4.3〜4.6 ステップ1〜4
（v1.0と同様のため省略）

---

## 5. アイコン説明メニュー（未実装）

（v1.0と同様のため省略）

---

## 6. 技術仕様

### 6.1 使用コンポーネント

| コンポーネント名 | 説明 | ステータス |
|----------------|------|----------|
| MobileBottomNav | タブ式ボトムナビゲーション | 実装済み |
| MobileHeader | ヘッダー（タイトル表示用） | 実装済み |
| Overlay | 汎用オーバーレイコンポーネント | 実装済み |
| RouteSearchOverlay | 経路検索オーバーレイ | 実装済み |
| WaypointMarkers | 経路ノードマーカー（移動/削除機能付き） | 実装済み |
| ExplorationMode | 探検モード全体管理 | 未実装 |
| CharacterBubble | キャラクター＋吹き出し | 未実装 |
| MiniMap | 小窓地図オーバーレイ | 未実装 |
| TourControlsCompact | コンパクトツアーコントロール | 未実装 |
| CertificateModal | 賞状モーダル | 未実装 |
| HelpOverlay | ヘルプオーバーレイ | 未実装 |

### 6.2 実装済みファイル構成

```
app/
├── components/
│   ├── Mobile/
│   │   ├── MobileHeader.tsx      # ヘッダーコンポーネント
│   │   ├── MobileBottomNav.tsx   # ボトムナビ（page.tsx内に実装）
│   │   ├── Overlay.tsx           # 汎用オーバーレイ
│   │   └── RouteSearchOverlay.tsx # 経路検索オーバーレイ
│   ├── Map/
│   │   ├── MapContainer.tsx      # 地図コンテナ（移動モード対応）
│   │   ├── WaypointMarkers.tsx   # 経路ノードマーカー（ボタン操作対応）
│   │   └── ...
│   └── Controls/
│       └── RouteControls.tsx     # 経路設定UI（操作説明更新済み）
├── page.tsx                       # メインページ（モバイル対応）
└── ...
lib/
└── useOverlay.ts                  # オーバーレイ状態管理フック
```

### 6.3 Overlay コンポーネント仕様

```typescript
interface OverlayProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  disableBackgroundClose?: boolean; // 背景タップで閉じない
}
```

**disableBackgroundClose オプション**:
- `true`: 背景が`pointer-events-none`になり、地図操作が可能
- `false`（デフォルト）: 背景タップでオーバーレイを閉じる

### 6.4 WaypointMarkers コンポーネント仕様

```typescript
interface WaypointMarkersProps {
  waypoints: Waypoint[];
  onDelete: (id: string) => void;
  onMove: (id: string, lat: number, lng: number) => void;
  isDrawingRoute: boolean;
  isMovingWaypoint?: boolean;
  onMovingWaypointChange: (isMoving: boolean) => void;
}
```

**移動モード管理**:
- 内部で`movingWaypointId`状態を管理
- `onMovingWaypointChange`で親に通知
- 親の`MapClickHandler`が移動モード中は新規ノード追加をスキップ

---

## 7. 実装状況

### Phase 1（完了）
- [x] MobileBottomNav コンポーネント
- [x] Overlay コンポーネント
- [x] RouteSearchOverlay コンポーネント
- [ ] HelpOverlay コンポーネント

### Phase 2（完了）
- [x] 経路検索オーバーレイのコンパクト化（S/G横並び）
- [x] オーバーレイ表示中の地図操作対応
- [x] 経路描画中の危険地点マーカー無効化
- [x] 経路ノードの移動/削除ボタン操作
- [x] 移動モードの実装（地図クリックで移動先選択）

### Phase 3（未実装）
- [ ] ExplorationMode コンポーネント
- [ ] MiniMap コンポーネント
- [ ] TourControlsCompact コンポーネント

### Phase 4（未実装）
- [ ] CharacterBubble コンポーネント
- [ ] CertificateModal コンポーネント
- [ ] アニメーション実装

---

## 8. 既知の課題・検討事項

### 8.1 解決済み
- ~~経路検索オーバーレイが大きすぎる~~ → コンパクト化済み
- ~~オーバーレイ表示中に地図操作ができない~~ → disableBackgroundClose対応
- ~~危険地点マーカーが経路描画中に反応する~~ → disabled対応
- ~~長押し削除がモバイルで不安定~~ → ボタン操作に変更
- ~~ノード移動時に新規ノードも生成される~~ → 移動モード状態管理で解決

### 8.2 未解決・検討中
- 探検モードの詳細UI設計
- キャラクターアニメーションの実装方法
- 賞状のデザイン詳細

---

## 9. 付録

### 9.1 カラーパレット

| 用途 | カラーコード |
|-----|-------------|
| メインカラー | #E60012（Honda Red） |
| アクセント | #FFD700（Gold） |
| 背景 | #FFFFFF |
| テキスト | #333333 |
| サブテキスト | #666666 |
| 危険警告 | #FF6B6B |
| 成功 | #4CAF50 |
| 移動モードハイライト | #FBBF24 |

### 9.2 経路ノードカラー

| タイプ | カラーコード | ラベル |
|-------|-------------|--------|
| start | #22C55E | S |
| end | #EF4444 | G |
| via | #3B82F6 | 1, 2, 3... |
