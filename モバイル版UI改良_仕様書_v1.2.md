# 通学路安全確認デモアプリ モバイル版UI改良 仕様書

**文書バージョン**: 1.2
**作成日**: 2026年1月16日
**最終更新日**: 2026年1月18日
**ステータス**: 実装中

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2026/01/16 | 初版作成 |
| 1.1 | 2026/01/17 | Phase 1-2実装完了に伴う仕様更新、経路ノード操作仕様の変更 |
| 1.2 | 2026/01/18 | Phase 3-6実装完了、探検モード・ツアー機能・キャラクター機能の仕様追加 |

---

## 1. 概要

### 1.1 目的
モバイル版アプリのUIを改良し、より直感的で子供と保護者が一緒に楽しめる「通学路探検モード」を実装する。

### 1.2 対象ユーザー
- 小学生とその保護者
- スマートフォンでの利用を想定

### 1.3 主な変更点
- 画面下部にタブ式メニューを配置（実装済み）
- 経路検索オーバーレイの実装（実装済み）
- 新機能「通学路探検モード」の追加（実装済み）
- キャラクターによるガイド機能（実装済み）
- 完了時の賞状風演出（未実装）

---

## 2. 画面構成

### 2.1 基本レイアウト（実装済み）

```
┌─────────────────────────────────┐
│                                 │
│                                 │
│         地図表示エリア           │
│         （フルスクリーン）        │
│                                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│  ボトムナビゲーション（タブ式）    │
└─────────────────────────────────┘
```

### 2.2 ボトムナビゲーション（実装済み）

| メニュー項目 | アイコン | 説明 |
|-------------|---------|------|
| 経路検索 | Route | 出発地〜目的地の経路設定 |
| 通学路探検 | Backpack | 探検モードの開始（実装済み） |
| ヘルプ | HelpCircle | 危険タイプ説明・操作ガイド（実装済み） |

**デザイン仕様（実装済み）**:
- 高さ: 64px
- 背景色: #FFFFFF（白）
- 上部ボーダー: 1px solid #E5E5E5
- メニューアイテム: 均等配置、タップ領域は高さ全体
- アクティブ状態: 青色ハイライト

---

## 3. 経路検索機能（実装済み）

### 3.1 概要
既存の経路検索機能をオーバーレイ形式で表示する。

### 3.2 オーバーレイUI（実装済み）

```
┌─────────────────────────────────┐
│                                 │
│         地図表示エリア           │
│                                 │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ 経路検索              ✕    │ │
│ ├─────────────────────────────┤ │
│ │ [S] スタート  [G] ゴール   │ │ ← 横並びレイアウト
│ ├─────────────────────────────┤ │
│ │ 操作ヒント（1行表示）       │ │
│ ├─────────────────────────────┤ │
│ │ [クリア] [ルート計算]      │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│  ボトムナビゲーション            │
└─────────────────────────────────┘
```

### 3.3 動作フロー（実装済み）
1. ボトムナビから「経路検索」をタップ
2. オーバーレイが画面下部から表示
3. **オーバーレイ表示中も地図操作が可能**（背景タップで閉じない）
4. 地図をタップしてスタート/ゴールを設定
5. 「ルート計算」で経路を表示
6. ✕ボタンでオーバーレイを閉じる

### 3.4 経路ノード操作仕様（実装済み・変更あり）

**PC版・モバイル版共通**:
- マーカーをクリック/タップ → ポップアップ表示
- ポップアップ内の「移動」ボタン → 移動モードに切り替え
  - 地図をクリック/タップして新しい位置に移動
  - 「キャンセル」ボタンまたはESCキーで解除
- ポップアップ内の「削除」ボタン → ノードを削除

**変更理由**:
- 当初はPC版で「長押しで削除、ドラッグで移動」を採用していたが、操作が競合するため統一
- モバイル版の長押し削除も不安定だったため、ボタン操作に変更

**操作説明テキスト（RouteControls.tsx）**:
```
• クリック: 地点を追加（最初=出発、途中=経由）
• ダブルクリック: 目的地を設定して終了
• マーカーをクリック → 移動/削除ボタンで操作
```

---

## 4. 通学路探検モード（実装済み）

### 4.1 概要
保護者と子供が一緒に通学路の危険について考える体験型学習モード。

### 4.2 キャラクター仕様

**キャラクター名**: 未定（仮称: セーフティにゃん）

**画像ファイル**: `public/images/character_v2.png`（配置済み）
- ヘルメットを被った白猫
- Hondaのバンダナ着用
- 表情: 笑顔

**表示仕様**:
- サイズ: 80px × 80px（モバイル）
- 位置: 画面右下（吹き出しの左側）
- 背景: なし（透過PNG使用）
- アニメーション: バウンスイン効果

### 4.3 探検モードの状態遷移

```
idle（未開始）
    ↓ startExploration()
route_setting（経路設定中）
    ↓ startTour()
touring（ツアー中）
    ↓ stopAtHazard()        ↓ completeTour()
hazard_stop（危険地点停止）    completed（完了）
    ↓ resumeTour()
touring（ツアー中に戻る）
```

### 4.4 ステップ1: 経路設定画面（RouteSetup）

**UI構成**:
- 画面下部に半透明のオーバーレイ
- キャラクターと吹き出し（左下）
- 「探検をはじめる！」ボタン（経路設定完了時に有効化）
- 「やめる」ボタン

**動作**:
1. 地図をタップして出発地点を設定
2. ダブルタップでゴール地点を設定
3. 経路が自動計算される
4. 「探検をはじめる！」ボタンでツアー開始

### 4.5 ステップ2: ツアー画面（TourScreen）

**UI構成**:
```
┌─────────────────────────────────┐
│ [🗺️探検中] [危険地点付近] [✕]  │ ← ヘッダー
├─────────────────────────────────┤
│                        ┌─────┐ │
│                        │MiniMap│ │ ← 右上に小窓地図
│    Street View         └─────┘ │
│    （全画面表示）              │
│                                │
│ ┌───────┐                      │
│ │進捗    │                      │ ← 左下に進捗表示
│ └───────┘                      │
├─────────────────────────────────┤
│ ◀ ▶ ⏸ ────────────── 1x 2x 3x │ ← コントロールバー
└─────────────────────────────────┘
```

**MiniMap（小窓地図）仕様**:
- サイズ: 100px × 100px
- 位置: 画面右上（top-4 right-4）
- 表示内容:
  - 経路線（青色）
  - 危険地点マーカー（タイプ別アイコン）
  - 現在位置マーカー（赤丸＋方向矢印）
- 地図操作: 無効（表示のみ）
- 地図は現在位置に追従してパン

**コントロールバー（TourControlsCompact）仕様**:
- 再生/一時停止ボタン
- 前進/後退ボタン
- プログレスバー（スライダー式）
- 速度切り替え（1x/2x/3x）

### 4.6 ステップ3: 危険地点停止画面（HazardStopScreen）

**UI構成**:
```
┌─────────────────────────────────┐
│ [⚠️危険地点に到着！]            │ ← 警告ヘッダー（赤背景）
├─────────────────────────────────┤
│ [🔴事故多発] 〇〇交差点         │ ← 危険地点情報バー
├─────────────────────────────────┤
│                        ┌─────┐ │
│    Street View         │MiniMap│ │ ← 右上に小窓地図
│    （半透明オーバーレイ）       │
│                        └─────┘ │
│                                │
│               ┌──────────────┐ │
│               │ キャラクター │ │ ← 右下にキャラクター
│               │ ＋吹き出し   │ │
│               └──────────────┘ │
│      ● ○ ○                    │ ← 進行状況インジケーター
├─────────────────────────────────┤
│ [危険地点の説明テキスト]        │
│ [安全ヒント]                    │
└─────────────────────────────────┘
```

**セリフシーケンス（3段階）**:
1. 「ここには、どんな危ない場所がひそんでいそうかな？」（まわりをよく見てみよう）
2. 「見つけた危ない場所で身を守るにはどうしたらいいかな？」（考えてみよう）
3. 「続きの道を進もう！」（タップしてツアーを再開）

**動作**:
- 吹き出しをタップすると次のセリフへ進む
- 3段階目をタップするとツアーを再開

### 4.7 探検モード中の危険地点ポップアップ

**仕様変更**:
- 探検モードのツアー中（`touring`）および危険地点停止中（`hazard_stop`）は、通常の`SafetyGuideOverlay`を非表示にする
- 危険地点情報は`HazardStopScreen`内で専用UIとして表示

---

## 5. アイコン説明メニュー（HelpOverlay）（実装済み）

### 5.1 概要
危険地点タイプの説明と基本操作ガイドを表示するオーバーレイ。

### 5.2 表示内容
- 危険地点タイプ一覧（アイコン、色、説明）
  - 見通しの悪い交差点（黄色三角）
  - 事故多発エリア（赤丸）
  - 急ブレーキ多発地点（オレンジ）
  - ユーザー投稿情報（吹き出し）
- 基本操作説明

---

## 6. 技術仕様

### 6.1 使用コンポーネント

| コンポーネント名 | 説明 | ステータス |
|----------------|------|----------|
| MobileBottomNav | タブ式ボトムナビゲーション | 実装済み |
| MobileHeader | ヘッダー（タイトル表示用） | 実装済み |
| Overlay | 汎用オーバーレイコンポーネント | 実装済み |
| RouteSearchOverlay | 経路検索オーバーレイ | 実装済み |
| WaypointMarkers | 経路ノードマーカー（移動/削除機能付き） | 実装済み |
| HelpOverlay | ヘルプオーバーレイ | 実装済み |
| ExplorationMode | 探検モード全体管理 | 実装済み |
| RouteSetup | 探検モード経路設定画面 | 実装済み |
| TourScreen | 探検モードツアー画面 | 実装済み |
| HazardStopScreen | 危険地点停止画面 | 実装済み |
| CharacterBubble | キャラクター＋吹き出し | 実装済み |
| MiniMap | 小窓地図オーバーレイ | 実装済み |
| TourControlsCompact | コンパクトツアーコントロール | 実装済み |
| CertificateModal | 賞状モーダル | 未実装 |

### 6.2 実装済みファイル構成

```
app/
├── components/
│   ├── Mobile/
│   │   ├── MobileHeader.tsx           # ヘッダーコンポーネント
│   │   ├── Overlay.tsx                # 汎用オーバーレイ
│   │   ├── RouteSearchOverlay.tsx     # 経路検索オーバーレイ
│   │   ├── HelpOverlay.tsx            # ヘルプオーバーレイ
│   │   └── ExplorationMode/           # 探検モード関連
│   │       ├── index.tsx              # 探検モード全体管理
│   │       ├── RouteSetup.tsx         # 経路設定画面
│   │       ├── TourScreen.tsx         # ツアー画面
│   │       ├── HazardStopScreen.tsx   # 危険地点停止画面
│   │       ├── CharacterBubble.tsx    # キャラクター＋吹き出し
│   │       ├── MiniMap.tsx            # 小窓地図
│   │       └── TourControlsCompact.tsx # コンパクトコントロール
│   ├── Map/
│   │   ├── MapContainer.tsx           # 地図コンテナ
│   │   ├── WaypointMarkers.tsx        # 経路ノードマーカー
│   │   └── ...
│   └── Controls/
│       └── RouteControls.tsx          # 経路設定UI
├── page.tsx                           # メインページ
└── ...
lib/
├── useOverlay.ts                      # オーバーレイ状態管理フック
├── useExplorationMode.ts              # 探検モード状態管理フック
├── useTour.ts                         # ツアー状態管理フック
└── types.ts                           # 型定義
```

### 6.3 MiniMap コンポーネント仕様

```typescript
interface MiniMapProps {
  routeCoordinates: [number, number][];
  currentPosition: [number, number] | null;
  heading: number;
  hazardPoints?: HazardPoint[];
  className?: string;
}
```

**機能**:
- Leaflet.jsを使用した小窓地図
- 経路線の描画（青色ポリライン）
- 危険地点マーカーの表示（タイプ別アイコン・色）
- 現在位置マーカーの表示（赤丸＋方向矢印）
- 地図は現在位置に追従してパン
- 地図操作（ドラッグ、ズーム等）は無効

**実装上の注意点**:
- `isMapReady`状態を使用して、地図初期化完了後にマーカー描画を行う
- SSR非対応のため`dynamic import`で読み込む

### 6.4 CharacterBubble コンポーネント仕様

```typescript
interface CharacterBubbleProps {
  message: string;
  subMessage?: string;
  onTap?: () => void;
  showTapIndicator?: boolean;
  position?: "left" | "right";
  className?: string;
}
```

**アニメーション**:
- キャラクター: バウンスイン効果（0.5秒）
- 吹き出し: フェードイン＋スケール効果（0.3秒、遅延0.3秒）

### 6.5 useExplorationMode フック仕様

```typescript
interface UseExplorationModeReturn {
  state: ExplorationState;
  isActive: boolean;
  startPoint: Waypoint | null;
  goalPoint: Waypoint | null;
  hasValidRoute: boolean;
  startExploration: () => void;
  setRoutePoints: (start: Waypoint | null, goal: Waypoint | null) => void;
  startTour: () => void;
  stopAtHazard: () => void;
  resumeTour: () => void;
  completeTour: () => void;
  resetExploration: () => void;
  exitExploration: () => void;
}
```

---

## 7. 実装状況

### Phase 1（完了）
- [x] MobileBottomNav コンポーネント
- [x] Overlay コンポーネント
- [x] RouteSearchOverlay コンポーネント
- [x] HelpOverlay コンポーネント

### Phase 2（完了）
- [x] 経路検索オーバーレイのコンパクト化（S/G横並び）
- [x] オーバーレイ表示中の地図操作対応
- [x] 経路描画中の危険地点マーカー無効化
- [x] 経路ノードの移動/削除ボタン操作
- [x] 移動モードの実装（地図クリックで移動先選択）

### Phase 3（完了）
- [x] useExplorationMode フック
- [x] ExplorationMode コンポーネント
- [x] RouteSetup コンポーネント

### Phase 4（完了）
- [x] MiniMap コンポーネント
- [x] TourControlsCompact コンポーネント

### Phase 5（完了）
- [x] TourScreen コンポーネント
- [x] Street View統合

### Phase 6（完了）
- [x] CharacterBubble コンポーネント
- [x] HazardStopScreen コンポーネント
- [x] セリフシーケンス機能
- [x] 探検モード中の危険地点ポップアップ非表示対応
- [x] MiniMapへの経路線・危険地点・現在位置マーカー表示

### Phase 7（未実装）
- [ ] CertificateModal コンポーネント
- [ ] 完了画面の実装

---

## 8. 既知の課題・検討事項

### 8.1 解決済み
- ~~経路検索オーバーレイが大きすぎる~~ → コンパクト化済み
- ~~オーバーレイ表示中に地図操作ができない~~ → disableBackgroundClose対応
- ~~危険地点マーカーが経路描画中に反応する~~ → disabled対応
- ~~長押し削除がモバイルで不安定~~ → ボタン操作に変更
- ~~ノード移動時に新規ノードも生成される~~ → 移動モード状態管理で解決
- ~~探検開始時にStreet Viewが表示されない~~ → startTour関数の条件チェック修正
- ~~キャラクター吹き出しのタップが反応しない~~ → pointer-events対応
- ~~MiniMapの自車アイコンが移動中に消える~~ → isMapReady状態による再描画対応

### 8.2 未解決・検討中
- 賞状のデザイン詳細
- 完了画面のUI設計

---

## 9. 付録

### 9.1 カラーパレット

| 用途 | カラーコード |
|-----|-------------|
| メインカラー | #E60012（Honda Red） |
| アクセント | #FFD700（Gold） |
| 背景 | #FFFFFF |
| テキスト | #333333 |
| サブテキスト | #666666 |
| 危険警告 | #FF6B6B |
| 成功 | #4CAF50 |
| 移動モードハイライト | #FBBF24 |
| キャラクター吹き出しボーダー | #FBBF24（yellow-400） |

### 9.2 経路ノードカラー

| タイプ | カラーコード | ラベル |
|-------|-------------|--------|
| start | #22C55E | S |
| end | #EF4444 | G |
| via | #3B82F6 | 1, 2, 3... |

### 9.3 MiniMap マーカーカラー

| マーカータイプ | カラーコード | 説明 |
|--------------|-------------|------|
| 現在位置 | #EF4444 | 赤丸＋方向矢印 |
| 経路線 | #3B82F6 | 青色ポリライン |
| 危険地点 | HAZARD_TYPE_INFO参照 | タイプ別色 |

### 9.4 アニメーション仕様

| アニメーション | 対象 | 時間 | イージング |
|--------------|------|------|----------|
| characterBounce | キャラクター登場 | 0.5s | ease-out |
| bubbleFadeIn | 吹き出し登場 | 0.3s | ease-out |
| mapPan | 地図パン | 0.3s | linear |
